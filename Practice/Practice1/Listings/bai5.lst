C51 COMPILER V9.60.0.0   BAI5                                                              12/05/2021 10:15:47 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE BAI5
OBJECT MODULE PLACED IN .\Objects\bai5.obj
COMPILER INVOKED BY: E:\Long\Keil5\C51\BIN\C51.EXE bai5.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\b
                    -ai5.lst) TABS(2) OBJECT(.\Objects\bai5.obj)

line level    source

   1          #include <at89x51.h>
   2          #define TH0_50ms 0x3C;
   3          #define TL0_50ms 0xB0;
   4          
   5          //Buzzer (speaker) connects on P1^5 
   6          sbit SPK  = P1^5; //Buzzer on/off
   7          sbit LED7SEG_0 = P1^0;  //Led 7-seq 1 not
   8          sbit LED7SEG_1 = P1^1;  //Led 7-seq 2 not
   9          sbit LED7SEG_2 = P1^2;  //Led 7-seg 3 anot
  10          sbit LED7SEG_3 = P1^3;  //Led 7-seg 4 anot
  11          
  12          unsigned char oldkey=0xff;  //Push button data (release status)
  13          //Define 2 push buttons (3,4) on Port P3
  14          sbit button3 = P3^4;  //Push button 3
  15          sbit button4 = P3^5;  //Push button 4
  16          
  17          unsigned char const mask[10]={0xC0, 0xF9, 0xA4, 0xB0, 0x99, 0x92, 0x82, 0xF8, 0x80, 0x90};
  18          
  19          int time = 0; // current time
  20          int count= 0; // number of interrupt by timer0
  21          
  22          void init(){
  23   1        // thiet lap ngat ngoai
  24   1        P3_2 = 1; //3_2 input for interrupt 0
  25   1        P3_3 = 1;
  26   1        EX0 = 1; //Cho phep ngat ngoai 0
  27   1        IT0 = 1; //Ngat theo suon
  28   1        EX1 = 1;
  29   1        IT1 = 1;
  30   1        
  31   1        EA   = 1;     //global interrupt enable
  32   1      }
  33          
  34          
  35          void delay(unsigned int time){                  
  36   1          while(time--);
  37   1      }
  38          
  39          
  40          void display(unsigned int time){
  41   1          unsigned int digit, num=time;
  42   1          
  43   1          const unsigned int D_DISPLAY =5000;
  44   1          
  45   1          // make sure LED 0, 1 are off
  46   1          LED7SEG_0=1; LED7SEG_1=1;
  47   1          
  48   1          // SET LED 3
  49   1          LED7SEG_3 = 0;
  50   1          digit = num % 10;
  51   1          num = num / 10;
  52   1          P0 = mask[digit];
  53   1          delay(D_DISPLAY);
  54   1          LED7SEG_3 = 1;
C51 COMPILER V9.60.0.0   BAI5                                                              12/05/2021 10:15:47 PAGE 2   

  55   1          
  56   1          // SET LED 2
  57   1          LED7SEG_2 = 0;
  58   1          digit = num % 10;
  59   1          num = num / 10;
  60   1          P0 = mask[digit];
  61   1          delay(D_DISPLAY);
  62   1          LED7SEG_2 = 1;
  63   1      }
  64          
  65          
  66          
  67          void EX0_Handler() interrupt IE0_VECTOR {
  68   1          EA=0; //Cam ngat
  69   1          
  70   1          /*turn on timer 0*/
  71   1          //timer 0
  72   1          TMOD = TMOD & 0xF0; 
  73   1          TMOD = TMOD | 0x01;
  74   1          TH0  = TH0_50ms;    //Khoi tao T0
  75   1          TL0  = TL0_50ms;    //Tuong duong 55536
  76   1          TF0  = 0;       //Xoa co tran timer 0
  77   1          TR0  = 1;       //Khoi dong timer 0
  78   1          ET0  = 1;     //cho phep ngat
  79   1            
  80   1          EA=1; //Cho phep ngat
  81   1          
  82   1      }
  83          
  84          void EX1_Handler() interrupt IE1_VECTOR {
  85   1          EA=0; //Cam ngat
  86   1        
  87   1          /* stop buzzer */
  88   1          SPK=0;
  89   1          /* stop timer 0*/
  90   1          TF0  = 0;       //clear flag
  91   1          TR0  = 0;       //stop timer
  92   1          ET0  = 0;       //cam ngat
  93   1        
  94   1          EA=1; //Cho phep ngat
  95   1          
  96   1      }
  97          
  98          void TMR0_Handler() interrupt TF0_VECTOR{
  99   1        TF0  = 0;       //clear flag
 100   1        TR0  = 0;       //stop timer
 101   1        TH0  = TH0_50ms;  //reset T0 value
 102   1        TL0  = TL0_50ms;  
 103   1        
 104   1        if(count>15){
 105   2            count=0;
 106   2            if (time>0) 
 107   2                time--;
 108   2            else if (time==0) 
 109   2                SPK=1;
 110   2        } else {
 111   2            count++;
 112   2        }
 113   1        
 114   1        TR0  = 1;       //restart timer
 115   1      }
 116          
C51 COMPILER V9.60.0.0   BAI5                                                              12/05/2021 10:15:47 PAGE 3   

 117          unsigned char read_button(){
 118   1          unsigned char button = 0;
 119   1          
 120   1          if((P3&0x30)!=0x30){ // if P3^4 or P3^5 is pressed
 121   2              delay(10);      //Delay for buzzer pulse
 122   2              if(oldkey!=(P3&0x30)){  //if any buttons pressed
 123   3                  oldkey=P3&0x30;   //Update button's values    
 124   3                  if(button3==0)
 125   3                      button=3;     //Button 3 pressed
 126   3                  else if(button4==0)
 127   3                      button=4;     //Button 4 pressed
 128   3              }
 129   2          } else {
 130   2              oldkey=0x30;    //Default data of buttons port
 131   2          }
 132   1          return button;
 133   1      }
 134          
 135          void main(){
 136   1          SPK=0;
 137   1          init();
 138   1          
 139   1          while(1){
 140   2              display(time);
 141   2              switch(read_button()){
 142   3                  case 3:
 143   3                    if (time<99) time++;
 144   3                    break;
 145   3                  case 4:
 146   3                    if (time>0) time--;
 147   3                    break;
 148   3              }
 149   2          }
 150   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    343    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     15       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
